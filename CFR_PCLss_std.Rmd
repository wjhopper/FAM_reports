---
title: "CFR PCL Ss Standard Model"
author: "Will Hopper"
date: "`r Sys.Date()`"
output: 
  html_document:
    fig_caption: yes
    toc: true
    toc_depth: 2
    css: custom.css
---
```{r setup, cache=FALSE,echo=FALSE, warning=F, include=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = FALSE,fig.width=11,fig.height=7,cache=FALSE, 
               warning=F, message=FALSE, fig.align='center')
library(dplyr)
library(FAM)
library(PCL)
library(reshape2)
library(whoppeR)
library(grid)
library(gridExtra)
library(ggplot2)
library(xtable)
model_prefix <- c("CFR_PCL", "std")
source("fitCFR_PCL.R")
```

```{r labellers}
  classNames <- list(
    'np'="No Practice",
    'sp'="Study Practice",
    'tp'="Test Practice"
  )  
  
  classLabeller <- function(variable,value) {        
    if (variable=='class') {
      return(classNames[value])
    } else {
      return(value)
    }
  }
  
```

```{r fetchData}
CFR_tested <- filter(CFR_allSs,
                     list != 0, score== 1,
                     phase=='final' | (phase=='prac' & practice =='T')) %>%
    mutate(RTrounded = round(RT,1)) %>%
    group_by(subject,phase,list) %>%
    mutate(testOrder = 1:n())
```

```{r load_or_fit}
resultsFile <- paste(paste0(model_prefix, collapse = "_"),
                  'results',sep='_')
if (!file.exists(file.path("data",paste(resultsFile,'.rds',sep=''))))  {
  model <- list(par = c(ER=.53,LR=.1,TR =.05, FR=.05),
                fn = CFR_PCL, method="Nelder-Mead", itnmax = 1000,
                fixed=  c(theta=.5,nFeat=100,nSim=1000,nList=15,
                          lambda=.2,Tmin=2,Tmax=10,Time=90),
                data = CFR_tested,
                fitting = TRUE,
                objective_fcn = model_prefix[1],
                name = model_prefix[2])
  results <- fitCFR_PCL(model,inpar=TRUE)
  saveRDS(results,
          file = file.path("data",paste(resultsFile,'.rds',sep='')))  
} else {
  results <- readRDS(file.path("data",paste(resultsFile,'.rds',sep='')))
}
  
preds <- do.call(rbind,lapply(lapply(results$results,`[[`, 'preds'),
                              `[[`, 'preds'))
dist <- do.call(rbind,lapply(lapply(results$results,`[[`, 'preds'),
                             `[[`, 'dist'))
fits <- do.call(rbind,lapply(results$results,`[[`, 'fit'))
```

# Model Specs
```{r modelInfo,results='asis'}
print(xtable(t(as.matrix(results$par)), digits=3,
             caption = paste("Starting Free Parameters")),
      type = "html", include.rownames=FALSE, caption.placement="top")
print(xtable(t(as.matrix(results$fixed)), digits=3,
             caption = paste("Fixed Parameters")),
      type = "html", include.rownames=FALSE, caption.placement="top")
```

# Model Results by Subject
```{r SSdata}
  cols <- c("subject","class","order")
  CFR_tested[,cols] <- lapply(CFR_tested[,cols],factor)
  preds[,cols] <- lapply(preds[,cols],factor)
  
  median_data <- CFR_tested %>% group_by(subject,class,order) %>% 
    summarise(acc = sum(score)/4,
              medianRT = median(RT))
  median_preds <- preds %>% group_by(subject,class,order) %>% 
    summarise(pred_acc = mean(pred_acc),
              pred_medianRT = median(pred_RT,na.rm=TRUE))
  sub_data <- left_join(median_preds,median_data)
  sub_data$acc[is.na(sub_data$acc)] <- 0   
```

```{r SSplots,results='asis'}
k <- 1
for (i in unique(sub_data$subject)) {
  rtPlot <- ggplot(data =sub_data[sub_data$subject==i,],aes(x=order)) +
    geom_point(aes(y=medianRT,shape="data")) +
    geom_line(aes(y=medianRT,group=class)) +
    geom_point(aes(y=pred_medianRT,shape="model")) +
    geom_line(aes(y=pred_medianRT,group=class)) + 
    facet_grid(. ~ class,labeller = classLabeller) +
    scale_x_discrete("Output Item") + 
    scale_y_continuous("Median First Press RT") +
    scale_shape_manual("",values=c("data"=1,"model"=2),labels=c("Obs. Data","PCL Model")) + 
    theme_larger() + 
    ggtitle("Data vs. PCL: Median RT")
  
  accPlot <- ggplot(data =sub_data[sub_data$subject==i,],aes(x=order)) +
    geom_point(aes(y=acc,shape="data")) +
    geom_line(aes(y=acc,group=class)) +
    geom_point(aes(y=pred_acc,shape="model")) +
    geom_line(aes(y=pred_acc,group=class)) + 
    facet_grid(. ~ class,labeller = classLabeller) +
    scale_x_discrete("Output Item") + 
    scale_y_continuous("Accuracy") +
    scale_shape_manual("",values=c("data"=1,"model"=2),labels=c("Data","PCL")) + 
    theme_larger() + 
    ggtitle("Data vs. PCL: Accuracy")
  
  densityPlot <- ggplot(data =dist[dist$subject==i,],aes(x=RTrounded,y=RTdist)) + 
    geom_line(size=.75) +
    facet_grid(class~order) +
    geom_point(data = CFR_tested[CFR_tested$subject==i,],
               mapping=aes(x=RTrounded),y=0,color="blue") + 
    scale_x_continuous(limits=c(0,max(CFR_tested$RTrounded[CFR_tested$subject==i]+5))) + 
    theme_larger() + 
    theme(axis.text.x = element_text(size=rel(1))) + 
    ggtitle("Model Density")  
}
```
# Averaged Results
```{r averages,results='asis'}
aggData <- CFR_tested %>% group_by(class,order) %>% 
    summarise(acc = sum(score)/(length(unique(sub_num))*4),
              err = sqrt(sum((score-acc)^2)/length(unique(sub_num))*4)/sqrt(length(unique(sub_num))*4),
              medianRT = median(RT),
              mad = median(abs(RT-medianRT),na.rm=TRUE)) %>%
    mutate(acc = replace(acc,is.na(acc),0),
           type = factor("data"))
  aggPreds <- preds %>% group_by(class,order) %>% 
    summarise(acc = mean(pred_acc),
              err = sd(pred_acc)/sqrt(n()),
              medianRT = median(pred_RT,na.rm=TRUE),
              mad = median(abs(pred_RT-medianRT),na.rm=TRUE)) %>%
    mutate(type = factor("model"))
  aggData <- rbind(aggData,aggPreds)
  
  aggDist <- dist %>% group_by(class,order,RTrounded) %>%
    summarise(RTdist = mean(RTdist))
    aggRTPlot <- ggplot(data =aggData,aes(x=order,y=medianRT,shape=type)) +
    geom_point() +
    geom_line(aes(group=interaction(class,type), linetype=type)) +
    geom_errorbar(aes(ymax=medianRT+mad, ymin=medianRT-mad),width=.15) +
    facet_grid(. ~ class,labeller = classLabeller) +
    scale_x_discrete("Output Item") + 
    scale_y_continuous("Median First Press RT") +
    scale_shape_manual("",values=c("data"=1,"model"=2),labels=c("Obs. Data","PCL Model")) + 
    scale_linetype_discrete(guide=FALSE) + 
    mytheme + 
    ggtitle("Data vs. PCL: Agg. Median RT")
  
aggAccPlot <- ggplot(data =aggData,aes(x=order,y=acc,shape=type)) +
    geom_point() +
    geom_line(aes(group=interaction(class,type), linetype=type)) +
    facet_grid(. ~ class,labeller = classLabeller) +
    scale_x_discrete("Output Item") + 
    scale_y_continuous("Accuracy") +
    scale_shape_manual("",values=c("data"=1,"model"=2),labels=c("Obs. Data","PCL Model")) + 
    scale_linetype_discrete(guide=FALSE) + 
    mytheme + 
    ggtitle("Data vs. PCL: Accuracy")
  
aggDensityPlot <- ggplot(data =aggDist,aes(x=RTrounded,y=RTdist)) + 
    geom_line(size=.75) +
    facet_grid(class~order) +
    geom_point(data = CFR_tested,
               mapping=aes(x=RTrounded),y=0,color="blue") + 
    scale_x_continuous(limits=c(0,max(CFR_tested$RTrounded+2.5))) +
    mytheme + theme(axis.text.x = element_text(size=rel(1))) + 
    ggtitle("Average Model Density")  
```
