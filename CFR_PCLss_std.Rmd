---
title: "CFR PCL Model"
author: "Will Hopper"
date: "`r Sys.Date()`"
output: 
  html_document:
    fig_caption: yes
    toc: true
    toc_depth: 2
    css: custom.css
params:
  inpar: FALSE
  model: CFR_PCL
  pars: !r c("ER","LR","TR","alpha","lambda","Tmin")
  fixed: !r c(FR=0,theta=.5,nFeat=100,nSim=1000,nList=15,Time=90, Tmax = 90)

---

```{r setup, cache=FALSE,echo=FALSE, warning=F, include=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = FALSE,fig.width=11,fig.height=7,cache=FALSE, 
               warning=F, message=FALSE, fig.align='center')
library(dplyr)
library(FAM)
library(PCL)
library(reshape2)
library(whoppeR)
library(grid)
library(gridExtra)
library(ggplot2)
library(xtable)
library(tidyr)
source("fitCFR_PCL.R")
```

```{r labellers}
  classNames <- list(
    'np'="No Practice",
    'sp'="Study Practice",
    'tp'="Test Practice"
  )  
  
  classLabeller <- function(variable,value) {        
    if (variable=='class') {
      return(classNames[value])
    } else {
      return(value)
    }
  }
  
```

```{r fetchData}
CFR_tested <- filter(CFR_allSs,
                     list != 0, score== 1,
                     phase=='final' | (phase=='prac' & practice =='T')) %>%
    ungroup() %>%
    mutate(RTrounded = round(RT,1),
           class=factor(class)) %>%
    group_by(subject,phase,list) %>%
    mutate(testOrder = 1:n()) %>% 
    select(-order) %>%
    rename(order=testOrder) %>%
    ungroup() %>% 
    complete(subject,class,order, cond_list, fill=list(score=0))
```

```{r load_or_fit}
  free <- list(c(ER=.6,LR=.035,TR =.05,FR=.1,alpha=.02,lambda=.4,Tmin=.5,Tmax=40), #1
               c(ER=.5,LR=.075,TR =.1,FR=.01,alpha=.04,lambda=.7,Tmin=.5,Tmax=56), #2
               c(ER=.5,LR=.06,TR =.025,FR=.025,alpha=.025,lambda=.5,Tmin=.5,Tmax=60), #3
               c(ER=.52,LR=.05,TR =.01,FR=.01,alpha=.025,lambda=.25,Tmin=.5,Tmax=30), #4
               c(ER=.52,LR=.125,TR =.05,FR=.00,alpha=.025,lambda=.9,Tmin=.5,Tmax=62), #5
               c(ER=.5,LR=.075,TR =.1,FR=.02,alpha=.03,lambda=.45,Tmin=.5,Tmax=55), #6
               c(ER=.5,LR=.11,TR =.01,FR=.02,alpha=.025,lambda=.5,Tmin=.5,Tmax=35), #7
               c(ER=.5,LR=.1,TR =.05,FR=.01,alpha=.02,lambda=.75,Tmin=.5,Tmax=40), #8
               c(ER=.46,LR=.05,TR =.025,FR=.01,alpha=.0285,lambda=.75,Tmin=.5,Tmax=45), #9 
               c(ER=.54,LR=.08,TR =.05,FR=.00,alpha=.025,lambda=.5,Tmin=.5,Tmax=60), #10
               c(ER=.5,LR=.125,TR =.05,FR=.025,alpha=.02,lambda=.5,Tmin=.5,Tmax=40), #11
               c(ER=.55,LR=.075,TR =.025,FR=.05,alpha=.02,lambda=.75,Tmin=.5,Tmax=60), #12
               c(ER=.55,LR=.1,TR =.05,FR=.00,alpha=.02,lambda=.75,Tmin=.5,Tmax=15), #13
               c(ER=.51,LR=.075,TR =.025,FR=.05,alpha=.025,lambda=.75,Tmin=.5,Tmax=55), #14
               c(ER=.48,LR=.075,TR =.05,FR=.025,alpha=.0225,lambda=.5,Tmin=.5,Tmax=60), #15
               c(ER=.52,LR=.1,TR =.1,FR=.00,alpha=.025,lambda=.75,Tmin=.5,Tmax=40), #16
               c(ER=.51,LR=.2,TR =.05,FR=.00,alpha=.02,lambda=.75,Tmin=.5,Tmax=15), #17
               c(ER=.55,LR=.05,TR =.05,FR=.05,alpha=.02,lambda=.5,Tmin=.5,Tmax=25), #18
               c(ER=.48,LR=.15,TR =.05,FR=.01,alpha=.025,lambda=.5,Tmin=.5,Tmax=45), #19
               c(ER=.5,LR=.12,TR =.15,FR=.00,alpha=.0285,lambda=.5,Tmin=.5,Tmax=70), #20
               c(ER=.47,LR=.05,TR =.05,FR=.00,alpha=.04,lambda=1,Tmin=.5,Tmax=45), #21
               c(ER=.5,LR=.05,TR =.05,FR=.00,alpha=.025,lambda=.75,Tmin=.5,Tmax=40), #22 
               c(ER=.55,LR=.025,TR =.025,FR=.05,alpha=.0222,lambda=.75,Tmin=.5,Tmax=25), #23
               c(ER=.55,LR=.025,TR =.05,FR=0,alpha=.025,lambda=.75,Tmin=.5,Tmax=50), #24
               c(ER=.56,LR=.01,TR =.05,FR=.025,alpha=.025,lambda=.5,Tmin=.5,Tmax=25), #25
               c(ER=.51,LR=.0,TR =.01,FR=.05,alpha=.028,lambda=1,Tmin=.5,Tmax=65), #26
               c(ER=.48,LR=.125,TR =.05,FR=.05,alpha=.033,lambda=.25,Tmin=.5,Tmax=70), #27
               c(ER=.51,LR=.1,TR =.05,FR=0,alpha=.0222,lambda=.5,Tmin=.5,Tmax=50), #28
               c(ER=.48,LR=.025,TR =.1,FR=.0,alpha=.02,lambda=.75,Tmin=.5,Tmax=25), #29
               c(ER=.54,LR=.025,TR =.05,FR=.05,alpha=.025,lambda=.75,Tmin=.5,Tmax=35), #30
               c(ER=.47,LR=.1,TR =.15,FR=0,alpha=.0285,lambda=.75,Tmin=.5,Tmax=30), #31
               c(ER=.5,LR=.12,TR =.05,FR=0,alpha=.02,lambda=.75,Tmin=.5,Tmax=65), #32
               c(ER=.5,LR=.1,TR =.05,FR=.05,alpha=.025,lambda=.75,Tmin=.5,Tmax=35), #33
               c(ER=.5,LR=.1,TR =.05,FR=.05,alpha=.04,lambda=.75,Tmin=.5,Tmax=46)) #34

  if (!all(unlist(lapply(lapply(free,names), setequal, params$pars)))) {
    stop("Model specs in header don't match free parameters. Edit header or list of free parameters")
  }

  fname <- paste(params$model,
                 paste0(params$pars,collapse="_"),
                 sep="_")
  fpath <- file.path("data",paste(fname,'rds',sep='.'))
  model <- list(free = free,
                fixed =  fixed,                
                fn = CFR_PCL,
                method="Nelder-Mead",
                data = CFR_tested,
                name = fname)
 
if (!file.exists(fpath))  {
  results <- fitCFR_PCL(model,inpar =params$inpar)
  saveRDS(results, file = fpath)  
} else {
  results <- readRDS(fpath)
}
  
preds <- do.call(rbind,lapply(results$results,`[[`, 'preds'))
dist <- do.call(rbind,lapply(results$results,`[[`, 'distribution'))
fits <- do.call(rbind,lapply(results$results,`[[`, 1))
```

# Fixed Model Specs
```{r modelInfo,results='asis'}
print(xtable(t(as.matrix(results$fixed)), digits=3,
             caption = paste("Fixed Parameters")),
      type = "html", include.rownames=FALSE, caption.placement="top")
```

# Model Results by Subject
```{r SSdata}

  accData <- CFR_tested %>% 
    group_by(subject,class,order) %>% 
    summarise(acc = mean(score)) %>%
    mutate(type="real") %>%
    rbind(data.frame(select(preds,-RT),type="model"))
  
  RTdata <- select(CFR_tested, subject,class, order,RT) %>%
    mutate(class = as.character(class), type="real") %>%
    rbind(data.frame(select(preds,-acc),type="model"))
  
```

```{r SSplots,results='asis'}
k <- 1
for (i in unique(preds$subject)) {
  rtPlot <- ggplot(data =RTdata[RTdata$subject==i,],
                   aes(x=order,y=RT, shape=type,color=type)) +
    geom_point() +
    geom_line(data = RTdata[RTdata$subject==i & RTdata$type=="model",],
              linetype=2) +
    facet_grid(. ~ class,labeller = classLabeller) +
    scale_x_discrete("Output Item") + 
    scale_shape_discrete(name="") + 
    scale_linetype_discrete(guide=FALSE) + 
    scale_y_continuous("Median First Press RT") +
    ggtitle("Data vs. PCL: Median RT")
  
  accPlot <- ggplot(data =accData[accData$subject==i,],
                   aes(y=acc, x=order,shape=type)) +
    geom_point() +
    geom_line(aes(linetype=type,group=type)) +
    facet_grid(. ~ class,labeller = classLabeller) +
    scale_x_discrete("Output Item") + 
    scale_shape_discrete(name="") + 
    scale_y_continuous("Median First Press RT") +
    scale_linetype_discrete(guide=FALSE) + 
    ggtitle("Data vs. PCL: Accuracy")
  
  densityPlot <- ggplot(data =dist[dist$subject==i,],aes(x=RTrounded,y=RTdist)) + 
    geom_line(size=.75) +
    facet_grid(class~order) +
    geom_point(data = CFR_tested[CFR_tested$subject==i,],
               mapping=aes(x=RTrounded),y=0,color="blue") + 
    scale_x_continuous(limits=c(0,max(CFR_tested$RTrounded[CFR_tested$subject==i]+5,
                                      na.rm=TRUE))) + 
    theme(axis.text.x = element_text(size=rel(1))) + 
    ggtitle("Model Density")
  
  print(rtPlot)
  print(accPlot)
  print(densityPlot)
  print(xtable(t(data.frame(free[i])), digits=3, caption = paste("Starting Parameters")),
          type = "html", include.rownames=FALSE, caption.placement="top")    
  print(xtable(fits[i,], digits=3, caption = paste("Best Parameters")),
          type = "html", include.rownames=FALSE, caption.placement="top")  
}
```

# Averaged Results
```{r averages,results='asis'}
aggAccData <- accData %>% 
    group_by(class,order,type) %>% 
    summarise(acc = mean(acc))
  
aggRTdata <- RTdata %>%
  group_by(class,order,type) %>%
  summarise(RT = median(RT,na.rm=TRUE))

aggDist <- dist %>% 
  group_by(class,order,RTrounded) %>%
  summarise(RTdist = mean(RTdist))
  
aggRTPlot <- ggplot(data =aggAccData,
                    aes(x=order,y=acc,shape=type)) +
  geom_point() +
  geom_line(aes(group=interaction(class,type), linetype=type)) +
  facet_grid(. ~ class,labeller = classLabeller) +
  scale_shape_discrete(name="") + 
  scale_x_discrete("Output Item") + 
  scale_y_continuous("Median First Press RT") +
  scale_linetype_discrete(guide=FALSE) + 
  ggtitle("Data vs. PCL: Agg. Median RT")

aggAccPlot <- aggRTPlot %+% aggRTdata + aes(y=RT) +
    scale_y_continuous("RT") +
    ggtitle("Data vs. PCL: Accuracy")
  
aggDensityPlot <-  densityPlot %+% aggDist +
    ggtitle("Average Model Density")  

print(aggRTPlot)
print(aggAccPlot)
print(aggDensityPlot)

avg_res <- summarise_each(fits,funs(mean))
print(xtable(as.matrix(avg_res[1:which(names(avg_res)=='fit.value')]),
             digits=3, caption = paste("Average Parameters")),
        type = "html", include.rownames=FALSE, caption.placement="top")
```
